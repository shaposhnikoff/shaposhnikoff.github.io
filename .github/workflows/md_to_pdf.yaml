name: Update CV from MD to PDF

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Install Pandoc & LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-latex-base \
            texlive-latex-extra

      # 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –∏–∑ Markdown
      - name: Generate PDF from Markdown
        run: |
          pandoc index.md -o index.pdf \
            --pdf-engine=xelatex \
            --highlight-style=tango \
            -V geometry:margin=1in \
            -V mainfont="DejaVu Serif" # –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –∂–µ–ª–∞–µ–º—ã–π —à—Ä–∏—Ñ—Ç

      # 4. –ó–∞–≥—Ä—É–∂–∞–µ–º PDF –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: Upload PDF Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CV-PDF
          path: index.pdf

      # 5. –ö–æ–º–º–∏—Ç PDF-—Ñ–∞–π–ª–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Commit Generated PDF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "shaposhnikoff"
          git config user.email "max@shaposhnikoff.info"
          git add index.pdf
          git diff --cached --quiet || git commit -m "Update generated CV PDF"
          git push

      # 6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
      - name: Send Telegram Notification
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="‚úÖ *CV PDF –æ–±–Ω–æ–≤–ª—ë–Ω!* –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π. üéâ" \
            -d parse_mode="Markdown"


      - name: Send PDF to Telegram
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument \
            -F chat_id="$TELEGRAM_CHAT_ID" \
            -F document=@index.pdf \
            -F caption="üìÑ *–ù–æ–≤—ã–π CV PDF —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω!*" \
            -F parse_mode=Markdown
